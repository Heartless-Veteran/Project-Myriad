Fix null safety issues in this file and improve error handling
